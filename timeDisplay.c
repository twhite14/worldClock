//timeDisplay.c
//Version 0.3
//Driving a set of LED displays with the current time in different areas of the world.
#include <wiringPi.h>
#include <stdio.h>
#include <time.h>
#include <unistd.h>
#include <string.h>

//Lookup table to convert ascii to the appropriate 7-segment output (for use on the time displays)
const char asciiTo7Seg[128] =
{
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//32 (mostly numbers)
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xFC, 0x60, 0xDA, 0xF2, 0x66, 0xB6, 0xBE, 0xE0,
0xFE, 0xF6, 0x00, 0x00, 0x00, 0x12, 0x00, 0xE4,
//64 (uppercase letters)
0x00, 0xEE, 0x3E, 0x9C, 0x7A, 0x9E, 0x8E, 0xBE,
0x6E, 0x60, 0x78, 0xAE, 0x1C, 0xEC, 0x2A, 0xFC,
0xCE, 0xE6, 0x8C, 0xB6, 0x1E, 0xFC, 0x38, 0x7E,
0x6E, 0x76, 0xDA, 0x9C, 0x26, 0xF0, 0x00, 0x10,
//96 (lowercase letters (actually a copy of uppercase letters))
0x80, 0xEE, 0x3E, 0x9C, 0x7A, 0x9E, 0x8E, 0xBE,
0x6E, 0x60, 0x78, 0xAE, 0x1C, 0xEC, 0x2A, 0xFC,
0xCE, 0xE6, 0x8C, 0xB6, 0x1E, 0xFC, 0x38, 0x7E,
0x6E, 0x76, 0xDA, 0x9C, 0x0C, 0xF0, 0x02, 0x00,
};

//Lookup table to convert ascii to the appropriate 16-segment output (for use on the time zone displays)
const unsigned short asciiTo16Seg[128] =
{
0x0000, 0x0303, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF,
//32 (mostly numbers)
0x0000, 0x0110, 0x0044, 0x00F2, 0x9797, 0xB5B5, 0x2F2B, 0x0008,
0x0820, 0x2008, 0xB8B8, 0x9090, 0x2000, 0x8080, 0x0200, 0x2020,
0x4747, 0x0440, 0xC3C3, 0x87C3, 0x84C4, 0x8787, 0xC787, 0x2023,
0xC7C7, 0x84C7, 0x0201, 0x2001, 0x0820, 0x8083, 0x2008, 0x10C7,
//64 (uppercase letters)
0xDF47, 0xC4C7, 0xC7C7, 0x4307, 0x4747, 0xC307, 0xC007, 0x4787,
0xC4C4, 0x1313, 0x5213, 0xC824, 0x4304, 0x446C, 0x4C4C, 0x4747,
0xC0C7, 0x4F47, 0xC8C7, 0x8787, 0x1013, 0x4744, 0x6024, 0x6C44,
0x2828, 0x1028, 0x2323, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
//96 (lowercase letters (not yet supported))
0x0000, 0x0110, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

//Prototypes
void shiftRegisterWrite(int, int, unsigned short);
char reverseByte(char);
void clear7Seg(int, int, int);

int main()
{
    wiringPiSetup();

    int clkPin = 3;
    int datPin = 0;
    int latPin = 2;

    pinMode(clkPin, OUTPUT);
    pinMode(datPin, OUTPUT);
    pinMode(latPin, OUTPUT);

    char outputString[] = "1234567890XX";

    //printf(outputString);

    int i = 0;
    char segment = 0;
    unsigned short write0, write1, write2;
    while(1)
    {
        for(i = 0; i < 4; i++)
        {
            //Enable segment
            segment = (0x0080 >> i);

            //Construct data to write
            write0 = 0x0000;
            write1 = 0x0000;
            write2 = 0x0000;

            write0 = (reverseByte(asciiTo7Seg[(int)outputString[i]]) << 8) | segment;   //pull data from the ascii table
            write1 = (reverseByte(asciiTo7Seg[(int)outputString[i+4]]) << 8) | segment; //pull data from the ascii table
            write2 = (reverseByte(asciiTo7Seg[(int)outputString[i+8]]) << 8) | segment; //pull data from the ascii table
	    //writeThis = 0xFF00 | segment;
            shiftRegisterWrite(clkPin, datPin, write0);
            shiftRegisterWrite(clkPin, datPin, write1);
            shiftRegisterWrite(clkPin, datPin, write2);

            //usleep(1);
            digitalWrite(latPin, 1);
            //usleep(1);
            digitalWrite(latPin, 0);
            usleep(2000);

            //Clear for next run
            clear7Seg(clkPin, datPin, latPin);

            usleep(500);
        }
    }
    return 0;
}

void shiftRegisterWrite(int clkPin, int datPin, unsigned short data)
{
    int i = 0;
    int dataValue = 0;
    for(i = 0; i < 16; i++)
    {
        dataValue = data & (1 << (15 - i));
        digitalWrite(datPin, dataValue);
        //usleep(1);
        digitalWrite(clkPin, 1);
        //usleep(1);
        digitalWrite(clkPin, 0);
        //usleep(1);
    }
}

void clear7Seg(int clkPin, int datPin, int latPin)
{
    shiftRegisterWrite(clkPin, datPin, 0x0000);
    shiftRegisterWrite(clkPin, datPin, 0x0000);
    shiftRegisterWrite(clkPin, datPin, 0x0000);
    digitalWrite(latPin, 1);
    //usleep(1);
    digitalWrite(latPin, 0);
    //usleep(1);
}

char reverseByte(char x)
{
    char table[] = {
        0x00, 0x80, 0x40, 0xc0, 0x20, 0xa0, 0x60, 0xe0,
        0x10, 0x90, 0x50, 0xd0, 0x30, 0xb0, 0x70, 0xf0,
        0x08, 0x88, 0x48, 0xc8, 0x28, 0xa8, 0x68, 0xe8,
        0x18, 0x98, 0x58, 0xd8, 0x38, 0xb8, 0x78, 0xf8,
        0x04, 0x84, 0x44, 0xc4, 0x24, 0xa4, 0x64, 0xe4,
        0x14, 0x94, 0x54, 0xd4, 0x34, 0xb4, 0x74, 0xf4,
        0x0c, 0x8c, 0x4c, 0xcc, 0x2c, 0xac, 0x6c, 0xec,
        0x1c, 0x9c, 0x5c, 0xdc, 0x3c, 0xbc, 0x7c, 0xfc,
        0x02, 0x82, 0x42, 0xc2, 0x22, 0xa2, 0x62, 0xe2,
        0x12, 0x92, 0x52, 0xd2, 0x32, 0xb2, 0x72, 0xf2,
        0x0a, 0x8a, 0x4a, 0xca, 0x2a, 0xaa, 0x6a, 0xea,
        0x1a, 0x9a, 0x5a, 0xda, 0x3a, 0xba, 0x7a, 0xfa,
        0x06, 0x86, 0x46, 0xc6, 0x26, 0xa6, 0x66, 0xe6,
        0x16, 0x96, 0x56, 0xd6, 0x36, 0xb6, 0x76, 0xf6,
        0x0e, 0x8e, 0x4e, 0xce, 0x2e, 0xae, 0x6e, 0xee,
        0x1e, 0x9e, 0x5e, 0xde, 0x3e, 0xbe, 0x7e, 0xfe,
        0x01, 0x81, 0x41, 0xc1, 0x21, 0xa1, 0x61, 0xe1,
        0x11, 0x91, 0x51, 0xd1, 0x31, 0xb1, 0x71, 0xf1,
        0x09, 0x89, 0x49, 0xc9, 0x29, 0xa9, 0x69, 0xe9,
        0x19, 0x99, 0x59, 0xd9, 0x39, 0xb9, 0x79, 0xf9,
        0x05, 0x85, 0x45, 0xc5, 0x25, 0xa5, 0x65, 0xe5,
        0x15, 0x95, 0x55, 0xd5, 0x35, 0xb5, 0x75, 0xf5,
        0x0d, 0x8d, 0x4d, 0xcd, 0x2d, 0xad, 0x6d, 0xed,
        0x1d, 0x9d, 0x5d, 0xdd, 0x3d, 0xbd, 0x7d, 0xfd,
        0x03, 0x83, 0x43, 0xc3, 0x23, 0xa3, 0x63, 0xe3,
        0x13, 0x93, 0x53, 0xd3, 0x33, 0xb3, 0x73, 0xf3,
        0x0b, 0x8b, 0x4b, 0xcb, 0x2b, 0xab, 0x6b, 0xeb,
        0x1b, 0x9b, 0x5b, 0xdb, 0x3b, 0xbb, 0x7b, 0xfb,
        0x07, 0x87, 0x47, 0xc7, 0x27, 0xa7, 0x67, 0xe7,
        0x17, 0x97, 0x57, 0xd7, 0x37, 0xb7, 0x77, 0xf7,
        0x0f, 0x8f, 0x4f, 0xcf, 0x2f, 0xaf, 0x6f, 0xef,
        0x1f, 0x9f, 0x5f, 0xdf, 0x3f, 0xbf, 0x7f, 0xff,
    };
    return table[(int)x];
}
